# Blackout

Blackout is a load testing infrastructure for the
Orchestra SaaS platform.  We have ambitions to make some of the
facilities of this available as a file-driven DSL so it's easy to
build and customize test infrastructure.

This library is intended to be used both as a local test runner and a
master node for distributed testing.  Simulated load tests and reports
are generated by clj-gatling.

To observe system behavior under test, possibly customized to the
application in questions, we leverage Reimann, a high performance
stream-oriented statistics aggregator.

The use of Reimann for real-time charting and reporting is optional,
allowing blackout to be used as a standlone test platform against a
co-located server, such as in automated build and test.

TODO: We leverage Clojurecast to facilitate a, relatively simple,
distributed version of this framework to enable aggregating load data
across a set of child nodes

## Related Documentation

- [clj-gatling](https://github.com/mhjort/clj-gatling)
- [Riemann](http://riemann.io/)
- [Riemann Dashboard](http://riemann.io/dashboard.html)

## Block Diagram

Single node testing

System Under Test <-> Test Runner -> Report -> Reimann Server -> Reimann Dashboard

Cluster-based testing

Cluster Under Test <-> Test Runner(s) -> Dist Reports -> Reimann Server -> Reimann Dash

Hack clj-gatling with custom reporter to aggregate statistics on a
master node.  Streaming to Reimann is distributed.

## Pre-requisites for local testing

Blackout can be run from the command line via `lein run` or
interactively via `lein repl`.  At the command line, the arguments to
run are `<namespace> <simulation> <num_users> <request_count>`.  The
provide namespace should be on the JVM classpath, contain a variable
`simulations` such as `blackout.sb/simulations` that contains a map of
configured simulations to be indexed by the simulation argument.

The number of users dictates the number of concurrent simulation
agents and the number of requests is approximately how many
back-to-back requests all the simulations together will execute

When using Mac OS X, issue the following commands at the terminal: 

1. Install Riemann and associated tools
    1. `brew install riemann`
    2. `sudo gem install riemann-client riemann-tools riemann-dash`

2. Run Riemann and Riemann Dash
    1. `riemann ./src/riemann.config` 
    2. `sudo riemann-dash ./src/config.json` (sudo is necessary to permit writes for config saves)
    3. Open your web browser to http://localhost:4567 to see Riemann real-time stats

3. Run Blackout
    1. Run a blackout simulation `lein run blackout.sb ping 5 100`
    2. After, open report file, e.g. `open /tmp/20161215220318568/index.html`

## Pre-requisites for remote testing

1. Install Riemann on a test server

2. SSH with '-L 5556:localhost:5556' and run 'riemann'

3. SSH with '-L 4567:localhost:4567' and run 'sudo riemann-dash'

4. Install [leiningen](

4. cd /var/lib/blackout; lein repl

5. (do (require 'blackout.core) (in-ns 'blackout.core))

6. (run :login 10 2 {:context {:username "eslick" :password "password"}})

## Roadmap

- How to make load testing more generic?
- Use clojurecast to allow distributed test generators to coordinate, e.g. unique name generation.
- Use spec.test and/or simulant to generate test cases against specific APIs
- Ansible script for configuring a test node to run riemann, riemann
dash, blackout from a JAR and connect to upstream Reimann server
- Ansible script for creating a cluster of test nodes
- Parse a simple DSL for trivial testing based on a file located on
  the classpath, e.g. using CURL styel commands for individual steps
  with a simple variable substition model

## Copyright and License

Copyright Â© 2016 Vital Labs, Inc.

Released under the MIT License

